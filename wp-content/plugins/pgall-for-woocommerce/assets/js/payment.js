jQuery(function(a){"use strict";var b=a("form.checkout");_pafw.is_checkout_pay_page&&(b=a("form#order_review"));var c={$forms:[],init:function(){},is_blocked:function(a){return a.is(".processing")||a.parents(".processing").length},block:function(a){c.is_blocked(a)||(a.addClass("processing").block({message:null,overlayCSS:{background:"#fff",opacity:.6}}),c.$forms.push(a))},unblock:function(){_.each(c.$forms,function(a,b){a.removeClass("processing").unblock()}),c.$forms=[]}};a.fn.pafw_block_controller=c,a.fn.pafw_hook={hooks:[],add_filter:function(b,c){void 0===a.fn.pafw_hook.hooks[b]&&(a.fn.pafw_hook.hooks[b]=[]),a.fn.pafw_hook.hooks[b].push(c)},apply_filters:function(b,c){if(void 0!==a.fn.pafw_hook.hooks[b])for(var d=0;d<a.fn.pafw_hook.hooks[b].length;++d)c[0]=a.fn.pafw_hook.hooks[b][d](c);return c[0]}},a.fn.pafw_cancel_payment_by_user=function(b){var c=a.Deferred();return a.ajax({type:"POST",url:pafw_ajaxurl,dataType:"json",data:{action:_pafw.slug+"-pafw_ajax_action",payment_method:b,payment_action:"cancel_payment_request_by_user",_wpnonce:_pafw._wpnonce},complete:function(){c.resolve()}}),c.promise()};var d=function(){this.$form=null,this.init=function(b,d){this.$form=b,a("body").on("inicis_unblock_payment",c.unblock),this.$form.on(d,this.process_payment)},this.process_payment=function(b,d){if(document.getElementById("payment_form_inicis")||a(document.body).append('<div id="payment_form_inicis"></div>'),a("#payment_form_inicis").empty().append(d.payment_form),_pafw.is_mobile){var e=document.ini,f=e.paymethod.value;"bank"===f&&(e.P_APP_BASE.value="ON"),e.action="https://mobile.inicis.com/smart/"+f+"/",e.submit()}else INIStdPay.pay("SendPayForm_id")||c.unblock()}},e=function(){this.$form=null,this.init=function(c,d){this.$form=c,void 0===a.fn.pafw_kakaopay_return&&(a.fn.pafw_kakaopay_return=this.unblock.bind(this)),b.on(d,this.process_payment.bind(this))},this.unblock=function(a){a&&alert(a),c.unblock()},this.process_payment=function(a,b){_pafw.is_mobile?document.location.href=b.next_redirect_url:window.open(b.next_redirect_url,"popupKakaoPay","top=100, left=300, width=727px, height=512px, resizble=no, scrollbars=yes")||(alert(_pafw.i18n.popup_block_message),c.unblock())}},f=function(){this.$form=null,this.init=function(a,b){this.$form=a,this.$form.on(b,this.process_payment.bind(this)),void 0===window.nicepayClose&&(window.nicepayClose=this.close),void 0===window.nicepaySubmit&&(window.nicepaySubmit=this.submit)},this.process_payment=function(a,b){void 0!==b.redirect_url?window.location=b.redirect_url:this.process_single_payment(b)},this.process_single_payment=function(b){document.getElementById("payment_form_nicepay")||a(document.body).append('<div id="payment_form_nicepay"></div>');var d=a("#payment_form_nicepay");d.empty(),d.append(b.payment_form),_pafw.is_mobile?(this.$form.target="_self",document.tranMgr.submit()):goPay(document.payForm)||c.unblock()},this.close=function(){a.fn.pafw_cancel_payment_by_user(a("input[name=payment_method]:checked",this.$form).val())},this.submit=function(){document.payForm.submit()}},g=function(){this.$form=null,this.init=function(a,b){this.$form=a,this.$form.on(b,this.process_payment.bind(this))},this.process_payment=function(a,b){window.m_Completepayment=this.complete_payment_for_desktop.bind(this),_pafw.is_mobile?this.process_payment_for_mobile(b):this.process_payment_for_desktop(b)},this.process_payment_for_mobile=function(b){var c=a("body");c.find("#kpay_mobile_form").remove(),c.append(b.payment_form),a("#kpay_mobile_form").submit()},this.process_payment_for_desktop=function(b){a(this.$form).find("#kcp_payment_form").remove(),a(this.$form).append(b.payment_form),KCP_Pay_Execute(this.$form[0])},this.request_payment_for_desktop=function(){return a.ajax({type:"POST",url:pafw_ajaxurl,dataType:"json",data:{action:_pafw.slug+"-pafw_ajax_action",payment_method:a("input[name=payment_method]:checked",this.$form).val(),payment_action:"request_payment",data:this.$form.serialize(),_wpnonce:_pafw._wpnonce},success:function(a){void 0!==a?void 0!==a.success&&!0===a.success?window.location=a.data:(alert(a.data),c.unblock()):(alert("결재요청중 오류가 발생했습니다. 잠시 후 다시 시도해주세요."),c.unblock())}}),!1},this.complete_payment_for_desktop=function(b,d){if(GetField(this.$form[0],b),"0000"===this.$form[0].res_cd.value)d(),this.request_payment_for_desktop();else{var e=a("input[name=payment_method]:checked",this.$form).val();a.fn.pafw_cancel_payment_by_user(e).done(function(){d(),c.unblock()})}}},h=function(){this.$form=null,this.lgdwin=null,this.init=function(a,b){this.$form=a,this.$form.on(b,this.process_payment.bind(this))},this.process_payment=function(b,c){window.payment_return=this.payment_return.bind(this),document.getElementById("payment_form_lguplus")||a(document.body).append('<div id="payment_form_lguplus"></div>'),a("#payment_form_lguplus").empty().append(c.payment_form),_pafw.is_mobile?this.lgdwin=open_paymentwindow(document.getElementById("LGD_PAYINFO"),_pafw.lguplus_mode,"submit"):this.lgdwin=openXpay(document.getElementById("LGD_PAYINFO"),_pafw.lguplus_mode,"iframe",null,"","")},this.payment_return=function(a){var b;b=this.lgdwin.contentWindow||this.lgdwin.contentDocument,"0000"===b.document.getElementById("LGD_RESPCODE").value?(document.getElementById("LGD_PAYKEY").value=b.document.getElementById("LGD_PAYKEY").value,document.getElementById("LGD_PAYINFO").target="_self",document.getElementById("LGD_PAYINFO").action=a,document.getElementById("LGD_PAYINFO").submit()):(alert("LGD_RESPCODE (결과코드) : "+b.document.getElementById("LGD_RESPCODE").value+"\nLGD_RESPMSG (결과메시지): "+b.document.getElementById("LGD_RESPMSG").value),closeIframe(),c.unblock())}},i=function(){this.$form=null,this.init=function(c,d){this.$form=c,void 0===a.fn.pafw_kakaopay_return&&(a.fn.pafw_kakaopay_return=this.unblock.bind(this)),b.on(d,this.process_payment.bind(this))},this.unblock=function(a){a&&alert(a),c.unblock()},this.process_payment=function(a,b){_pafw.is_mobile?document.location.href=b.order_sheet_url:window.open(b.order_sheet_url,"popupPayco","top=100, left=300, width=727px, height=512px, resizble=no, scrollbars=yes")||(alert(_pafw.i18n.popup_block_message),c.unblock())}},j=function(){this.$form=null,this.gateways=null,this.init=function(b){this.$form=b;var c={inicis:new d,kakaopay:new e,nicepay:new f,kcp:new g,lguplus:new h,payco:new i};this.gateway_object=a.fn.pafw_hook.apply_filters("pafw_gateway_objects",[c]);var j=_pafw.supported_payment_methods.map(function(a){return"checkout_place_order_"+a}).join(" ");_pafw.is_checkout_pay_page?this.$form.on("submit",this.process_order_pay.bind(this)):this.$form.on(j,this.process_payment.bind(this)),_.each(_pafw.gateway,function(a,b){if(void 0!==this.gateway_object[b]){var c=_.keys(a).map(function(a){return"pafw_place_order_"+a}).join(" ");this.gateway_object[b].init(this.$form,c)}}.bind(this))},this.process_payment=function(){var b=this;if(c.is_blocked(b.$form))return!1;c.block(b.$form);var d="";return d="yes"===_pafw.simple_pay?pafw_ajaxurl+"?action="+_pafw.slug+"-pafw_simple_payment":wc_checkout_params.checkout_url,a.ajax({type:"POST",url:d,data:this.$form.serialize(),success:function(d){var e="";try{if(d.indexOf("\x3c!--WC_START--\x3e")>=0&&(d=d.split("\x3c!--WC_START--\x3e")[1]),d.indexOf("\x3c!--WC_END--\x3e")>=0&&(d=d.split("\x3c!--WC_END--\x3e")[0]),e=a.parseJSON(d),"success"!==e.result)throw"failure"===e.result?"Result failure":"Invalid response";var f=a("input[name=payment_method]:checked",b.$form).val();b.$form.trigger("pafw_place_order_"+f,e)}catch(f){if(!0===e.reload||"true"===e.reload)return void window.location.reload();a(".woocommerce-error, .woocommerce-message").remove(),e.messages?b.$form.prepend(e.messages):b.$form.prepend(d),b.$form.find(".input-text, select").blur(),a("html, body").animate({scrollTop:b.$form.offset().top-100},1e3),"true"===e.refresh&&a("body").trigger("update_checkout"),a("body").trigger("checkout_error"),c.unblock()}},dataType:"html"}),!1},this.process_order_pay=function(){var b=this;if(c.is_blocked(b.$form))return!1;c.block(b.$form);var d=a("input[name=payment_method]:checked",b.$form).val();if(-1!==_pafw.supported_payment_methods.indexOf(d))return a.ajax({type:"POST",url:pafw_ajaxurl,data:{action:_pafw.slug+"-pafw_ajax_action",payment_method:d,payment_action:"process_order_pay",order_id:_pafw.order_id,order_key:_pafw.order_key,data:b.$form.serialize(),_wpnonce:_pafw._wpnonce},success:function(a){void 0!==a&&void 0!==a.success&&!0===a.success?b.$form.trigger("pafw_place_order_"+d,a.data):alert(a.data),c.unblock()}}),!1}};a("body").trigger("pafw_init_hook"),_.each(b,function(b,c){(new j).init(a(b))})});